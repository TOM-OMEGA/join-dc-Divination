<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ¥• èƒ¡è˜¿è””å‘½é‹å åœç¥­å£‡ â€” è‘‰ç‰‡è¢«æ‹”èµ·</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root{
      --bg1:#2f1f13; --bg2:#160b06; --gold:#ffd66b; --earth:#2e1f14;
    }
    html,body{height:100%;margin:0;font-family:'Noto Serif TC',serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--gold);display:flex;align-items:center;justify-content:center;}
    .stage{width:100%;max-width:720px;padding:28px;box-sizing:border-box; text-align:center;}
    h1{margin:0 0 18px;font-size:1.6rem;letter-spacing:2px;text-shadow:0 0 8px rgba(200,150,60,0.25);}
    .scene{position:relative;height:420px;max-width:480px;margin:0 auto 18px;display:flex;align-items:flex-end;justify-content:center;pointer-events:none;}
    /* æ³¥åœŸ */
    .ground{
      width:320px;height:140px;border-radius:50%/30%;
      background:radial-gradient(circle at 50% 20%, #4b341f 0%, #2b1b11 58%, #1a1208 100%);
      box-shadow: inset 0 -12px 25px rgba(0,0,0,0.6), 0 10px 30px rgba(0,0,0,0.6);
      position:relative; overflow:visible;
    }
    /* è˜¿è””ï¼ˆç•™åœ¨åœŸè£¡ï¼‰ */
    .carrot{
      position:absolute; left:50%; transform:translateX(-50%); bottom:26px;
      width:72px; height:114px; border-radius:44% 44% 14% 14%;
      background: linear-gradient(180deg,#ff9e2a,#e36c0a 85%);
      box-shadow: inset 0 -6px 12px rgba(0,0,0,0.15);
      transition:box-shadow .3s;
      pointer-events:auto; z-index:3;
    }
    /* è˜¿è””é ‚ç«¯çš„å°å‚·å£ / å‰²å£ï¼ˆåœ¨æ‹”è‘‰å­å¾Œé¡¯ç¤ºï¼‰ */
    .stump{
      position:absolute; left:50%; transform:translateX(-50%); bottom:124px;
      width:40px; height:18px; border-radius:10px; background:#2a180f;
      opacity:0; transition:opacity .6s ease .3s; z-index:4;
      box-shadow: inset 0 2px 6px rgba(255,200,120,0.06);
    }
    /* è‘‰ç‰‡ï¼šæœƒè¢«æ‹”èµ·ï¼ˆç¨ç«‹æ–¼è˜¿è””ï¼‰ */
    .leaves{
      position:absolute; left:50%; transform:translateX(-50%); bottom:146px;
      width:120px; height:120px; pointer-events:auto; z-index:5;
      display:flex; align-items:flex-start; justify-content:center;
      transform-origin:center bottom;
    }
    /* ç”¨ SVG å½¢ç‹€åšè‘‰ç‰‡ï¼Œè®“å‹•ç•«å¯æ§ */
    .leaf-wrap{width:120px;height:90px; display:block; transform-origin:center bottom;}
    svg.leaf{width:120px;height:90px; display:block; overflow:visible;}
    /* å‹•ç•«é¡åˆ¥ */
    .pulling .leaves{animation:shake .45s ease-in-out 0s 1;}
    @keyframes shake{
      0%{ transform:translateX(-50%) translateY(0) rotate(0deg);}
      20%{ transform:translateX(-50%) translateY(-6px) rotate(-6deg);}
      40%{ transform:translateX(-50%) translateY(6px) rotate(6deg);}
      60%{ transform:translateX(-50%) translateY(-4px) rotate(-4deg);}
      100%{ transform:translateX(-50%) translateY(0) rotate(0deg);}
    }
    /* è¢«æ‹”èµ·çš„é£›å‡ºå‹•ç•«ï¼ˆæ‹”å‡ºå¾Œä½¿ç”¨ï¼‰ */
    .flying {
      animation:flyUp 1.2s cubic-bezier(.08,.82,.17,1) forwards;
    }
    @keyframes flyUp{
      0%{ transform:translateX(-50%) translateY(0) rotate(0) scale(1); opacity:1; filter:drop-shadow(0 6px 6px rgba(0,0,0,.25)); }
      30%{ transform:translateX(-60%) translateY(-40px) rotate(-14deg) scale(1.02); }
      65%{ transform:translateX(-120%) translateY(-170px) rotate(-60deg) scale(.85); opacity:0.95; }
      100%{ transform:translateX(-160%) translateY(-280px) rotate(-110deg) scale(.6); opacity:0; }
    }
    /* å¾®ç²’å­ï¼ˆæ³¥åœŸï¼‰ */
    .particles{position:absolute; left:50%; bottom:48px; transform:translateX(-50%); width:220px; height:80px; pointer-events:none; z-index:2; overflow:visible;}
    .particle{position:absolute;width:6px;height:6px;border-radius:50%;background:#5a3b22;opacity:0;transform:translateY(0);}
    /* æŒ‰éˆ•å€ */
    .controls{pointer-events:auto;margin-top:8px;}
    button{
      background:linear-gradient(180deg,#c89c2b,#8b6612);
      color:#fff8dc;border:none;padding:12px 22px;border-radius:10px;font-weight:700;cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.45);
    }
    button:disabled{opacity:.55;cursor:not-allowed;}
    /* çµæœå¡ */
    #resultCard{max-width:460px;margin:14px auto 0;background:rgba(20,12,6,.86);border:2px solid #cfa842;border-radius:12px;padding:18px;display:none;box-shadow:0 8px 30px rgba(0,0,0,.6);}
    #resultCard.show{display:block; animation:cardIn .5s ease;}
    @keyframes cardIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
    .muted{color:rgba(255,214,120,.7);font-size:.95rem}
    /* å°è£é£¾ */
    footer{margin-top:18px;color:rgba(255,214,120,.45);font-size:.86rem;}
    @media (max-width:480px){
      .scene{height:360px}
      .ground{width:90%}
      .carrot{width:56px;height:90px}
    }
  </style>
</head>
<body>
  <div class="stage">
    <h1>ğŸ”® èƒ¡è˜¿è””å‘½é‹å åœç¥­å£‡ï¼ˆè‘‰ç‰‡è¢«æ‹”èµ·ï¼‰</h1>

    <div class="scene" id="scene">
      <div class="ground" id="ground">
        <!-- è˜¿è””åœ¨åœŸä¸­ï¼ˆä¿æŒä¸å‹•ï¼‰ -->
        <div class="carrot" id="carrot"></div>

        <!-- é¡¯ç¤ºé ‚ç«¯å‰²å£ï¼ˆåˆå§‹éš±è—ï¼‰ -->
        <div class="stump" id="stump" aria-hidden="true"></div>

        <!-- è‘‰ç‰‡ï¼ˆç¨ç«‹æ–¼è˜¿è””ï¼‰ -->
        <div class="leaves" id="leaves" aria-hidden="false">
          <div class="leaf-wrap" id="leafWrap">
            <!-- SVG è‘‰ç‰‡ï¼šä½ å¯ä»¥æ›¿æ›æˆæ›´ç´°ç·»çš„å‘é‡ -->
            <svg class="leaf" viewBox="0 0 120 90" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <defs>
                <linearGradient id="lg" x1="0" x2="1"><stop offset="0" stop-color="#80c875"/><stop offset="1" stop-color="#2f9e3b"/></linearGradient>
              </defs>
              <g transform="translate(60,55)">
                <path d="M0,-6 C20,-30 60,-28 80,-6 C60,-18 25,-3 0,10 C-25,-3 -60,-18 -80,-6 C-60,-28 -20,-30 0,-6 Z"
                      fill="url(#lg)" stroke="#2a6b2a" stroke-width="1.6" />
              </g>
            </svg>
          </div>
        </div>

        <!-- æ³¥åœŸç²’å­å®¹å™¨ï¼ˆåˆ¶ä½œç°¡æ˜“ç²’å­æ•ˆæœï¼‰ -->
        <div class="particles" id="particles"></div>
      </div>
    </div>

    <div class="controls">
      <button id="pullBtn">æ‹”å‡ºä»Šæ—¥é‹å‹¢ï¼ˆæ‹”è‘‰ç‰‡ï¼‰ âœ¨</button>
    </div>

    <div id="resultCard" role="status" aria-live="polite">
      <div class="muted" id="resDate">ğŸ“œ å åœæ—¥æœŸï¼š-</div>
      <div id="resFortune" style="font-size:1.2rem;margin-top:8px;color:var(--gold)">ğŸ”® ä»Šæ—¥ç±¤æ–‡ï¼š-</div>
      <div id="resAdvice" style="margin-top:8px;color:#ffd"/> 
      <div style="margin-top:12px;">
        <button id="againBtn" style="background:linear-gradient(180deg,#9a6e1a,#6b4a0e);">å†æ‹”ä¸€æ¬¡</button>
      </div>
    </div>

    <footer>å»ºè­°ï¼šæŒ‰ä¸€æ¬¡è®“è‘‰ç‰‡è¢«æ‹”èµ·ï¼Œè˜¿è””æœƒç•™åœ¨æ³¥åœŸä¸­ã€‚</footer>
  </div>

  <script>
    // è¨­å®šï¼ˆä¿ç•™ä½ åŸæœ¬çš„ API åƒæ•¸ï¼‰
    const apiUrl = "https://carrot-bot-production.up.railway.app/api/fortune";
    const userId = "657882539331158016";
    const username = "æ¹¯å§†ç‘æ–—";

    // DOM
    const pullBtn = document.getElementById('pullBtn');
    const againBtn = document.getElementById('againBtn');
    const leaves = document.getElementById('leaves');
    const leafWrap = document.getElementById('leafWrap');
    const stump = document.getElementById('stump');
    const particlesEl = document.getElementById('particles');
    const scene = document.getElementById('scene');
    const resCard = document.getElementById('resultCard');
    const resDate = document.getElementById('resDate');
    const resFortune = document.getElementById('resFortune');
    const resAdvice = document.getElementById('resAdvice');

    // ç”Ÿæˆå¹¾å€‹æ³¥åœŸç²’å­å…ƒç´ ï¼ˆé å…ˆï¼‰
    function makeParticles(n=12){
      particlesEl.innerHTML = '';
      for(let i=0;i<n;i++){
        const p = document.createElement('div');
        p.className='particle';
        p.style.left = (30 + Math.random()*160) + 'px'; // ç¯„åœ
        p.style.bottom = (6 + Math.random()*8) + 'px';
        p.style.width = p.style.height = (4 + Math.random()*6) + 'px';
        p.style.opacity = 0;
        particlesEl.appendChild(p);
      }
    }
    makeParticles(16);

    // æ’­æ”¾ç°¡å–®æ³¥åœŸé£›æ•£å‹•ç•«
    function playParticles(){
      const parts = Array.from(particlesEl.children);
      parts.forEach((p, idx) => {
        const delay = idx * 30;
        p.style.transition = `transform 650ms cubic-bezier(.08,.82,.17,1) ${delay}ms, opacity 300ms ${delay}ms`;
        const dx = (Math.random()*160 - 80);
        const dy = -(80 + Math.random()*120);
        p.style.transform = `translate(${dx}px, ${dy}px) rotate(${(Math.random()*70-35)}deg)`;
        p.style.opacity = 1;
        setTimeout(()=> p.style.opacity = 0, 600 + delay);
      });
    }

    // åŸ·è¡Œ confettiï¼ˆè¦–è¦ºå¼·åŒ–ï¼‰
    function boomConfetti(){
      confetti({ particleCount: 120, spread: 90, scalar: 0.9, origin: { y: 0.6 } });
    }

    // å–å¾—ç±¤æ–‡ï¼ˆå¸¶ fallbackï¼‰
    async function fetchFortune(){
      try{
        const resp = await fetch(`${apiUrl}?user_id=${encodeURIComponent(userId)}&username=${encodeURIComponent(username)}`);
        if(!resp.ok) throw new Error('network');
        const data = await resp.json();
        // ç¢ºä¿æœ‰é—œéµæ¬„ä½
        return {
          date: data.date || new Date().toISOString().slice(0,10),
          fortune: data.fortune || "å¹³å®‰",
          advice: data.advice || "é †å…¶è‡ªç„¶å³å¯ã€‚"
        };
      }catch(e){
        // fallback ç¯„ä¾‹æ–‡æ¡ˆ
        return {
          date: new Date().toISOString().slice(0,10),
          fortune: ["å¤§å‰","ä¸­å‰","å°å‰","å¹³å®‰","æœ‰è®Šå‹•"].sort(()=>Math.random()-0.5)[0],
          advice: ["ä»Šæ—¥å®œå®ˆæˆï¼Œä¸å®œå†’é€²ã€‚","ä»Šå¤©ç¤¾äº¤é‹ä½³ï¼Œè©¦è‘—ä¸»å‹•æ‰“æ‹›å‘¼ã€‚","å°å¿ƒç´°ç¯€ï¼Œä¼‘æ¯è¶³å¤ ã€‚"][Math.floor(Math.random()*3)]
        };
      }
    }

    // ç•¶æŒ‰ä¸‹æ‹”è‘‰æŒ‰éˆ•
    pullBtn.addEventListener('click', async () => {
      if(pullBtn.disabled) return;
      pullBtn.disabled = true;
      pullBtn.textContent = 'æ‹”è‘‰ä¸­â€¦';

      // 1) è‘‰ç‰‡å…ˆçŸ­æš«æŠ–å‹•ï¼ˆçµ¦å‡ºè¢«æŠ“ä½çš„æ„Ÿè¦ºï¼‰
      scene.classList.add('pulling');

      // 2) ç•«é¢å°å»¶é²å¾ŒæŠŠè‘‰ç‰‡è¨­ç‚ºé£›å‡ºå‹•ç•«ï¼ˆè‘‰ç‰‡é›¢é–‹ï¼‰
      setTimeout(() => {
        // è§¸ç™¼æ³¥åœŸç²’å­
        playParticles();
        // è‘‰ç‰‡é£›å‡º
        leafWrap.classList.add('flying');
        // é¡¯ç¤ºè˜¿è””é ‚ç«¯ stumpï¼ˆåƒè¢«æ‹”ç©ºçš„ç—•è·¡ï¼‰
        stump.style.opacity = 1;
      }, 420);

      // 3) åŒæ­¥å»æŠ“ç±¤æ–‡ï¼ˆAJAXï¼‰
      const data = await fetchFortune();

      // 4) ç­‰è‘‰ç‰‡é£›å‡ºå‹•ç•«çµæŸå†é¡¯ç¤ºçµæœï¼ˆç•¥ç•™æ™‚é–“ï¼‰
      setTimeout(() => {
        // é¡¯ç¤ºçµæœå¡èˆ‡ confetti
        resDate.textContent = `ğŸ“œ å åœæ—¥æœŸï¼š${data.date}`;
        resFortune.textContent = `ğŸ”® ä»Šæ—¥ç±¤æ–‡ï¼š${data.fortune}`;
        resAdvice.textContent = `ğŸ’¡ å åœä¹‹è¨€ï¼š${data.advice}`;
        resCard.classList.add('show');
        boomConfetti();

        // æ¸…ç†ï¼šæŠŠè‘‰ç‰‡éš±è—ï¼ˆæˆ–ä¿ç•™ç¢ç‰‡æ•ˆæœï¼‰
        leafWrap.style.opacity = 0;
        // re-enable å†æŠ½ä¸€æ¬¡æŒ‰éˆ•
        pullBtn.disabled = false;
        pullBtn.textContent = 'æ‹”å‡ºä»Šæ—¥é‹å‹¢ï¼ˆæ‹”è‘‰ç‰‡ï¼‰ âœ¨';
      }, 1400);
    });

    // å†æŠ½ä¸€æ¬¡ï¼šé‡ç½®å‹•ç•«ï¼ˆè‘‰ç‰‡å›åˆ°åŸä½ï¼‰
    againBtn.addEventListener('click', () => {
      // é‡ç½®è‘‰ç‰‡ï¼ˆæŠŠ svg æ­¸ä½ï¼‰
      leafWrap.style.transition = 'opacity .3s';
      leafWrap.style.opacity = 1;
      leafWrap.classList.remove('flying');
      // é‡æ–°è§¸ç™¼ layoutï¼Œä¿è­‰å‹•ç•«å¯å†æ¬¡é‹è¡Œ
      void leafWrap.offsetWidth;
      stump.style.opacity = 0;
      resCard.classList.remove('show');
      makeParticles(16);
      // scroll to controlsï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    });

    // åˆå§‹åŒ–ï¼šç¢ºä¿æŒ‰éˆ•å¯é»
    (function init(){
      pullBtn.disabled = false;
      pullBtn.textContent = 'æ‹”å‡ºä»Šæ—¥é‹å‹¢ï¼ˆæ‹”è‘‰ç‰‡ï¼‰ âœ¨';
    })();
  </script>
</body>
</html>
