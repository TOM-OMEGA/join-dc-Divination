<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<title>å‘½é‹ä¹‹è”” Â· æ£®æ—å åœç¥­å£‡</title>

<link rel="icon" href="images/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="images/icon-192.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å‘½é‹ä¹‹è””">
<meta name="x5-orientation" content="landscape">
<meta name="full-screen" content="yes">
<meta name="x5-fullscreen" content="true">

<style>
:root{
  --paper:#f3ead5;
  --ink:#2e2316;
  --gold:#b9872b;

  /* å¯èª¿æ•´è®Šæ•¸ */
  --fortune-font-min:5rem;
  --fortune-font-vw:12vw;
  --fortune-font-max:8rem;
  --fortune-margin-top:5vh;    /* èª¿æ•´å¤§å‰å¾€ä¸‹çš„é‡ï¼ˆè² å€¼æœƒå¾€ä¸Šï¼‰ */
  --advice-top-gap:18px;      /* å¤§å‰èˆ‡å°å»ºè­°é–“è· */
  --advice-button-gap:18px;   /* å°å»ºè­°èˆ‡æŒ‰éˆ•é–“è· */
  --page3-padding-left-desktop:40px;
  --page3-padding-left-mobile-landscape:80px;
}

/* å­—å‹ï¼ˆè«‹ä¿ç•™ä½ ä¸Šå‚³çš„å­—æª”ï¼‰ */
@font-face {
  font-family: 'MyChineseFont';
  src: url('fonts/MyChineseFont.woff2') format('woff2'),
       url('fonts/MyChineseFont.woff') format('woff');
  font-display: swap;
}
@font-face {
  font-family: 'HanyiSentyPagoda';
  src: url('fonts/HanyiSentyPagoda-fixed.woff2') format('woff2'),
       url('fonts/HanyiSentyPagoda-fixed.woff') format('woff'),
       url('fonts/HanyiSentyPagoda-fixed.ttf') format('truetype');
  font-display: swap;
}

/* å…¨åŸŸ */
html, body {
  width:100%;height:100%;margin:0;padding:0;
  font-family:'MyChineseFont','Uncial Antiqua',serif;
  background:url('images/medieval-carrot-placeholder.jpg') no-repeat center center;
  background-size:contain;
  background-color:#000;
  color:var(--ink);
  overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  transition:background-image 1s ease-in-out;
}

/* é é¢å…±é€š */
.page{position:absolute;top:0;left:0;width:100%;height:100%;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  opacity:0;pointer-events:none;transform:scale(0.97);
  transition: opacity .8s ease, transform .8s ease;
}
.page.active{opacity:1;pointer-events:all;transform:scale(1);}

/* page1 / page2 ä¿æŒåŸæ¨£ */
#page1 h1{font-size:clamp(3.0rem,12vw,3.8rem);color:#4D2B0A;margin-bottom:1rem;text-align:center;}
#page1 .subtitle{font-size:35pt;color:#333;text-align:center;}
#page2 h1{font-size:clamp(2.8rem,10vw,3.6rem);color:#4D2B0A;text-align:center;margin-bottom:1rem;}
.qr { width:130px;height:130px;border-radius:8px;overflow:hidden;margin-bottom:10px;box-shadow:0 3px 8px rgba(0,0,0,0.4);flex-shrink:0;}
.qr img{width:100%;height:100%;object-fit:cover;}

/* ç¬¬3é ï¼ˆä¸»è¦è®Šæ›´ï¼‰ */
#page3{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  width:100%;
  height:100%;
  box-sizing:border-box;
  transition:all 0.6s ease;
}

/* ç•¶çµæœå‡ºç¾æ™‚ï¼Œæ•´å€‹ page3 è½‰ç‚ºå·¦å°é½Šä¸¦ä¿ç•™ paddingï¼ˆä¸æœƒå½±éŸ¿ç½®ä¸­ loadingï¼‰ */
#page3.left-align{
  align-items:flex-start;
  justify-content:center;
  text-align:left;
  padding-left:var(--page3-padding-left-desktop);
}

/* æ‰‹æ©Ÿæ©«å‘ï¼ˆä¿ç•™æ›´å¤§çš„å·¦è·ï¼‰ */
@media screen and (max-width: 1024px) and (orientation: landscape) {
  #page3.left-align { padding-left:var(--page3-padding-left-mobile-landscape) !important; }
}
/* æ‰‹æ©Ÿç›´å¼ï¼šçµæœä»ä¿æŒå±…ä¸­ï¼ˆä¸æ”¹å‹•ï¼‰ */
@media screen and (max-width: 768px) and (orientation: portrait) {
  #page3.left-align { align-items:center !important; justify-content:center !important; text-align:center !important; padding-left:0 !important;}
}

/* .divination ç•¶ä½œç›¸å°å®¹å™¨ï¼Œå…§éƒ¨ä½¿ç”¨çµ•å°å®šä½é¡¯ç¤ºç½®ä¸­ loading */
.divination{ position:relative; width:100%; max-width:940px; box-sizing:border-box; }

/* é è¨­ï¼ˆç½®ä¸­ï¼‰è¨Šæ¯ï¼ˆåœ¨æœªæŠ½æˆ–å›é¦–é æ™‚é¡¯ç¤ºï¼‰ */
.centeredIntro{
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  padding:12px 16px;
  box-sizing:border-box;
  font-size:clamp(1.2rem,4vw,1.6rem);
  color:var(--ink);
  text-align:center;
}

/* loading è¦†è“‹å±¤ï¼šçµ•å°ç½®ä¸­ã€é»æ“Šä¸æ””æˆªï¼ˆpointer-events:noneï¼‰*/
.loading-overlay{
  position:absolute;
  inset:0;
  display:none; /* JS æ§åˆ¶é¡¯ç¤º */
  align-items:center;
  justify-content:center;
  pointer-events:none;
  z-index:5;
  font-size:clamp(1.2rem,4.5vw,1.8rem);
  color:var(--ink);
  text-shadow: 0 2px 6px rgba(0,0,0,0.5);
}

/* çµæœå€ï¼ˆå¤§å‰ + å°å»ºè­° + æŒ‰éˆ•ï¼‰-- é è¨­éš±è—ï¼ŒæŠ½å®Œé¡¯ç¤º */
.result-area{
  display:none;
  width:100%;
  box-sizing:border-box;
  /* ä½¿ç”¨ flex column è®“å°å»ºè­°èˆ‡æŒ‰éˆ•ç¨ç«‹æ’åˆ— */
  display:flex;
  flex-direction:column;
  align-items:flex-start; /* å·¦å°é½Š */
  gap:var(--advice-top-gap);
  margin-top:0;
}

/* å¤§å‰ç­‰å­—ï¼ˆå›ºå®šä½¿ç”¨å¡”å­—é«”ï¼Œå·¦å°é½Šï¼‰ */
.fortune-text{
  font-family:'HanyiSentyPagoda','MyChineseFont',serif;
  font-size: clamp(var(--fortune-font-min), var(--fortune-font-vw), var(--fortune-font-max));
  line-height:1;
  margin:0;
  /* è®“å®ƒä¸æœƒæ¨æ“ ä¸‹æ–¹å…ƒç´ ï¼šä½¿ç”¨ transform åšè¦–è¦ºä¸Šçš„ã€Œç§»å‹•ã€ */
  transform: translateY(var(--fortune-margin-top));
  display:inline-block;
}

/* å°å»ºè­°ï¼ˆç¨ç«‹ï¼‰ */
.advice{
  margin:0;
  font-size:clamp(1rem,3.5vw,1.3rem);
  line-height:1.6;
  max-width:600px;
  color:#4b2d0a;
  font-family:'MyChineseFont';
  margin-top:0;
}

/* æŒ‰éˆ•æ¬„ï¼ˆå°å»ºè­°èˆ‡æŒ‰éˆ•çš„é–“è·å¯ç”±è®Šæ•¸æ§åˆ¶ï¼‰ */
.button-row{
  display:flex;
  gap:10px;
  margin-top:var(--advice-button-gap);
  align-items:center;
  justify-content:flex-start;
}

/* èƒ¡è˜¿è””åœ– */
.carrot-thumb{
  width:clamp(150px,25vw,220px);
  height:clamp(150px,25vw,220px);
  object-fit:contain;
  transition:opacity .6s ease, transform .4s ease;
}
.carrot-thumb.fade-out{opacity:0; transform:scale(.88);}

/* å…¶é¤˜æŒ‰éˆ•èƒŒæ™¯åœ–ï¼ˆä¿ç•™ä½ åŸæœ¬æŒ‰éˆ• classï¼‰ */
.btn{
  width:200px;height:64px;background-repeat:no-repeat;background-position:center;background-size:contain;background-color:transparent;border:0;padding:0;margin:0;cursor:pointer;appearance:none;outline:none;
}
.btn--start { background-image:url('./images/btn-start.png'); }
.btn--next  { background-image:url('./images/btn-next.png'); }
.btn--draw  { background-image:url('./images/btn-draw.png'); }
.btn--back  { background-image:url('./images/btn-back.png'); }
.btn--retry { background-image:url('./images/btn-retry.png'); }

footer{position:absolute;bottom:8px;font-size:.75rem;color:rgba(46,34,22,0.6);}
</style>
</head>
<body>

<!-- ç¬¬1é  -->
<div id="page1" class="page active">
  <h1>å‘½é‹ä¹‹è”” Â· æ£®æ—å åœç¥­å£‡</h1>
  <div class="subtitle">æ¢ç´¢å‘½é‹çš„å„€å¼ï¼Œå¾åŠ å…¥é–‹å§‹</div>
  <button id="startBtn" class="btn btn--start" aria-label="æˆ‘è¦åŠ å…¥"></button>
  <footer>Â© 2025 å‘½é‹ä¹‹è””</footer>
</div>

<!-- ç¬¬2é  -->
<div id="page2" class="page">
  <h1>æƒæ QRCODE åŠ å…¥ Discord</h1>
  <div class="qr">
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=130x130&data=https://discord.gg/mar4qT9XYn" alt="Discord QR">
  </div>
  <button id="joinedBtn" class="btn btn--next" aria-label="æˆ‘å·²åŠ å…¥"></button>
</div>

<!-- ç¬¬3é  -->
<div id="page3" class="page">
  <div class="divination">
    <img id="carrotThumb" class="carrot-thumb" src="./images/carrot-thumb.png" alt="èƒ¡è˜¿è””æ’ç•«">

    <!-- ç½®ä¸­é è¨­è¨Šæ¯ï¼ˆé¡¯ç¤ºåœ¨æœªæŠ½æ™‚ï¼‰ -->
    <div id="centeredIntro" class="centeredIntro">æŒ‰ä¸‹ <strong>å åœé‹å‹¢</strong> æŒ–å–ä½ çš„å‘½é‹ä¹‹è””</div>

    <!-- loading è¦†è“‹å±¤ï¼ˆæŠ½ç±¤æ™‚é¡¯ç¤ºï¼Œç½®ä¸­ï¼‰ -->
    <div id="loadingOverlay" class="loading-overlay" aria-hidden="true">ğŸ¥• æŒ–å–ä¸­... æ­£åœ¨èšé›†é­”åŠ›...</div>

    <!-- çµæœå€ï¼šå¤§å‰ï¼ˆé å·¦ï¼‰ / å°å»ºè­° / æŒ‰éˆ• -->
    <div id="resultArea" class="result-area" role="region" aria-live="polite">
      <div id="fortuneLineLeft"><!-- fortune-text æœƒè¢«æ’å…¥åœ¨é€™ --></div>
      <div id="adviceText" class="advice" style="display:none"></div>
      <div class="button-row">
        <button id="drawBtn" class="btn btn--draw" aria-label="å åœä»Šæ—¥é‹å‹¢"></button>
        <button id="backBtn" class="btn btn--back" aria-label="è¿”å›é¦–é "></button>
      </div>
    </div>
  </div>
</div>

<script>
const apiUrl = "https://carrot-bot-production.up.railway.app/api/web_fortune";
const userId = "657882539331158016";
const username = "æ¹¯å§†ç‘æ–—";

/* å…ƒä»¶ */
const startBtn = document.getElementById('startBtn');
const joinedBtn = document.getElementById('joinedBtn');
const page1 = document.getElementById('page1');
const page2 = document.getElementById('page2');
const page3 = document.getElementById('page3');

const centeredIntro = document.getElementById('centeredIntro');
const loadingOverlay = document.getElementById('loadingOverlay');
const resultArea = document.getElementById('resultArea');
const fortuneLineLeft = document.getElementById('fortuneLineLeft');
const adviceText = document.getElementById('adviceText');
const carrotThumb = document.getElementById('carrotThumb');
const drawBtn = document.getElementById('drawBtn');
const backBtn = document.getElementById('backBtn');

function transitionPage(currentId,nextId){
  const current=document.getElementById(currentId);
  const next=document.getElementById(nextId);
  if(!current||!next) return;
  current.classList.add('fade-out');
  setTimeout(()=>{
    current.classList.remove('active','fade-out');
    next.classList.add('active','fade-in');
    setTimeout(()=>next.classList.remove('fade-in'),600);
  },500);
}

startBtn.onclick = ()=> transitionPage('page1','page2');
joinedBtn.onclick = ()=> transitionPage('page2','page3');

/* è¿”å›é‚„åŸç½®ä¸­åˆå§‹ç‹€æ…‹ */
backBtn.onclick = ()=>{
  // éš±è—çµæœå€ã€é¡¯ç¤ºç½®ä¸­èªªæ˜èˆ‡èƒ¡è˜¿è””
  page3.classList.remove('left-align');
  resultArea.style.display = 'none';
  centeredIntro.style.display = 'flex';
  adviceText.style.display = 'none';
  fortuneLineLeft.innerHTML = '';
  carrotThumb.style.display = 'block';
  carrotThumb.classList.remove('fade-out');

  // æŒ‰éˆ•æ¨£å¼é‚„åŸ
  drawBtn.classList.remove('btn--retry');
  drawBtn.classList.add('btn--draw');

  // é‚„åŸèƒŒæ™¯
  document.body.style.backgroundImage = "url('./images/medieval-carrot-placeholder.jpg')";

  transitionPage('page3','page1');
};

/* å·¥å…·ï¼šXSS-safe */
function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* æŠ½ç±¤æŒ‰éˆ•è¡Œç‚ºï¼š
 - é»ä¸‹æ™‚é¡¯ç¤º loadingOverlayï¼ˆç½®ä¸­ï¼‰
 - æˆåŠŸå¾Œ hideloaderã€é¡¯ç¤º resultAreaï¼ˆå·¦å°é½Šï¼‰ä¸¦éš±è—ç½®ä¸­ intro
 - å¤§å‰åªé¡¯ç¤ºåœ¨å·¦å´ï¼Œä¸æœƒæ¨æ“ ä¸‹æ–¹ adviceï¼ˆæˆ‘å€‘ç”¨ transform ä¾†è¦–è¦ºç§»å‹•ï¼‰
*/
drawBtn.addEventListener('click', async ()=>{
  drawBtn.disabled = true;

  // é¡¯ç¤º loadingï¼ˆç½®ä¸­ï¼‰ï¼Œéš±è—ç½®ä¸­èªªæ˜ï¼ˆé¿å…é‡ç–Šï¼‰
  loadingOverlay.style.display = 'flex';
  centeredIntro.style.display = 'none';

  // éš±è—çµæœå€ç›´åˆ°æœ‰çµæœ
  resultArea.style.display = 'none';
  adviceText.style.display = 'none';

  try {
    const url = `${apiUrl}?user_id=${encodeURIComponent(userId)}&username=${encodeURIComponent(username)}&force_random=true&t=${Date.now()}`;
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('API éŒ¯èª¤ï¼š' + res.status);
    const data = await res.json();
    const fortune = data.fortune || "";

    // åˆ¤æ–·é‹å‹¢
    let fText = "", bg = "images/fortune_default.png", colorClass = '';
    if(fortune.includes("å¤§å‰")){ fText="å¤§å‰"; bg="images/å¤§å‰.jpg"; colorClass="å¤§å‰"; }
    else if(fortune.includes("ä¸­å‰")){ fText="ä¸­å‰"; bg="images/ä¸­å‰.jpg"; colorClass="ä¸­å‰"; }
    else if(fortune.includes("å°å‰")){ fText="å°å‰"; bg="images/å°å‰.jpg"; colorClass="å°å‰"; }
    else if(fortune.includes("å‰")){ fText="å‰"; bg="images/å‰.jpg"; colorClass="å‰"; }
    else if(fortune.includes("å‡¶")){ fText="å‡¶"; bg="images/å‡¶.jpg"; colorClass="å‡¶"; }
    else { fText = escapeHtml(fortune) || "æœªçŸ¥"; }

    // è¨­èƒŒæ™¯
    document.body.style.background = `url('${bg}') no-repeat center center/cover`;

    // é¡¯ç¤ºçµæœå€ï¼ˆå·¦å°é½Šï¼‰
    page3.classList.add('left-align');
    resultArea.style.display = 'flex';       // é¡¯ç¤ºæ•´å€‹çµæœå€ï¼ˆå·¦å°é½Šï¼‰
    fortuneLineLeft.innerHTML = `<span class="fortune-text ${colorClass}">${escapeHtml(fText)}</span>`;

    // é¡¯ç¤ºå°å»ºè­°
    adviceText.style.display = 'block';
    adviceText.innerHTML = `<p>${escapeHtml(data.advice || '')}</p>`;

    // éš±è—èƒ¡è˜¿è””ï¼ˆæ·¡å‡ºï¼‰
    carrotThumb.classList.add('fade-out');
    setTimeout(()=> carrotThumb.style.display = 'none', 600);

    // éš±è— loading
    loadingOverlay.style.display = 'none';

    // èª¿æ•´æŒ‰éˆ•æ¨£å¼ç‚º retry
    drawBtn.classList.replace('btn--draw','btn--retry');

  } catch(err){
    console.error(err);
    // é¡¯ç¤ºéŒ¯èª¤ä¸¦ä¿ç•™ loading éš±è—
    loadingOverlay.style.display = 'none';
    centeredIntro.style.display = 'flex';
    fortuneLineLeft.innerHTML = '';
    resultArea.style.display = 'none';
    adviceText.style.display = 'block';
    adviceText.innerHTML = `<p>é­”åŠ›å¹²æ“¾éå¼·ï¼Œç„¡æ³•å¾ç¥­å£‡è®€å–å‘½é‹ã€‚</p>`;
  } finally {
    drawBtn.disabled = false;
  }
});

/* Service workerï¼ˆä¿ç•™ï¼‰ */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js?v=9')
      .then(reg=>console.log('âœ… SW è¨»å†ŠæˆåŠŸ:',reg.scope))
      .catch(err=>console.log('âŒ SW è¨»å†Šå¤±æ•—:',err));
  });
}
</script>
</body>
</html>
