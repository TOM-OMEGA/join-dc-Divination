<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>å‘½é‹ä¹‹è”” Â· æ£®æ—å åœç¥­å£‡</title>

<link rel="icon" href="images/favicon.ico" type="image/x-icon">
<meta name="theme-color" content="#000000">

<style>
:root{
  /* ğŸª„ å…¨å±€èª¿æ•´å€ */
  --paper:#f3ead5;
  --ink:#2e2316;
  --gold:#b9872b;

  /* ç¬¬ä¸‰é æ–‡å­—èˆ‡é–“è· */
  --fortune-offset:5vh;       /* å¤§å‰æ–‡å­—å‚ç›´ä½ç§» */
  --fortune-left-offset:110px;  /* å¤§å‰æ–‡å­—è·å·¦é‚Šåç§» */
  --advice-left-offset: 50px;    /* å°å»ºè­°æ–‡å­—è·å·¦é‚Šåç§»ï¼ˆå¯åˆ†é–‹èª¿æ•´ï¼‰ */
  --fortune-gap:150px;         /* å¤§å‰æ–‡å­—èˆ‡å»ºè­°æ–‡å­—é–“è· */
  --draw-btn-gap:10px;         /* fortune/advice åˆ°æŒ‰éˆ•è·é›¢ */

  /* èƒ¡è˜¿è””åœ–ç‰‡å¤§å° */
  --carrot-size-min:150px;
  --carrot-size-max:220px;

  /* æŒ‰éˆ•å¤§å° */
  --btn-width:200px;
  --btn-height:64px;
}

/* å­—é«”è¨­å®š */
@font-face {
  font-family: 'MyChineseFont';
  src: url('/join-dc-Divination/fonts/MyChineseFont.woff') format('woff');
  font-display: swap;
}

@font-face {
  font-family: 'HanyiSentyPagoda';
  src: url('/join-dc-Divination/fonts/HanyiSentyPagoda-fixed.woff') format('woff'),
       url('/join-dc-Divination/fonts/HanyiSentyPagoda-fixed.ttf') format('truetype');
  font-display: swap;
}

/* å…¨åŸŸæ¨£å¼ */
html, body{
  width:100%; height:100%; margin:0; padding:0;
  font-family:'MyChineseFont','Uncial Antiqua',serif;
  background:url('./images/medieval-carrot-placeholder.webp') no-repeat center center;
  background-size:contain; background-color:#000;
  color:var(--ink);
  overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  transition:background-image 1s ease-in-out;
}

/* é é¢å…±é€š */
.page{
  position:absolute; top:0; left:0; width:100%; height:100%;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transform:scale(0.97);
  transition:opacity .8s ease, transform .8s ease;
}
.page.active{opacity:1; pointer-events:all; transform:scale(1);}

/* ç¬¬1é  */
#page1 h1{font-size:clamp(3rem,12vw,3.8rem); color:#4d2b0a; margin-bottom:1rem; text-align:center;}
#page1 .subtitle{font-size:35pt; color:#333; text-align:center;}

/* ç¬¬2é  */
#page2 h1{font-size:clamp(2.8rem,10vw,3.6rem); color:#4d2b0a; text-align:center; margin-bottom:1rem;}
.qr{width:130px; height:130px; border-radius:8px; overflow:hidden; margin-bottom:10px; box-shadow:0 3px 8px rgba(0,0,0,0.4);}
.qr img{width:100%; height:100%; object-fit:cover;}

/* ç¬¬3é  */
#page3{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  text-align:center; width:100%; height:100%; box-sizing:border-box;
  transition:all 0.6s ease;
}
#page3.left-align{
  align-items:flex-start; text-align:left; padding-left:40px; transition:padding-left 0.4s ease;
}
@media screen and (max-width:1024px) and (orientation:landscape){#page3.left-align{padding-left:80px !important;}}
@media screen and (max-width:768px) and (orientation:portrait){#page3.left-align{align-items:center!important;text-align:center!important;padding-left:0!important;}}

/* ç¬¬3é å…§å®¹ */
.fortune-container{position:relative; min-height:120px;}
.fortune-text-container{
  position:absolute;
  top: var(--fortune-offset);
  left: var(--fortune-left-offset);
  transform: translateX(0);
  font-family:'HanyiSentyPagoda', serif;
  font-size: clamp(8rem,12vw,12rem);
  pointer-events:none; 
  white-space:nowrap;
}
.fortune-text-container.å¤§å‰,
.fortune-text-container.ä¸­å‰,
.fortune-text-container.å°å‰,
.fortune-text-container.å‰,
.fortune-text-container.å‡¶{color:#4d2b0a;}

.fortune{font-size:clamp(1.2rem,4vw,1.8rem); z-index:1;}

/* æ–°å®¹å™¨: fortune-block ç®¡ç†æ–‡å­—èˆ‡é–“è· */
.fortune-block{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: var(--draw-btn-gap); /* fortune/advice åˆ°æŒ‰éˆ•è·é›¢ */
  margin-bottom:0;
}

.advice {
  position: relative;                  /* å…è¨±å·¦åç§» */
  margin-top: var(--fortune-gap);      /* èˆ‡é‹å‹¢æ–‡å­—çš„è·é›¢ */
  left: var(--advice-left-offset);     /* æ§åˆ¶å»ºè­°æ–‡å­—å·¦å³ä½ç§» */
  font-size: clamp(1.2rem, 2rem, 1.8rem);
  line-height: 1.6;
  max-width: 600px;
  color: #4b2d0a;
  font-family: 'MyChineseFont';
  text-align: left;                    /* è®“æ–‡å­—é å·¦å°é½Š */
  transition: margin-top .3s ease, left .3s ease;
}

/* æŒ‰éˆ• */
.button-row{
  display:flex; flex-direction:row; align-items:center; justify-content:center;
  gap:10px;
  min-height:64px;
}

.btn{
  width:var(--btn-width); height:var(--btn-height);
  display:inline-block; background-repeat:no-repeat; background-position:center; background-size:contain;
  background-color:transparent; border:0; padding:0; margin:10px 6px; cursor:pointer; z-index:10;
}
.btn:hover{transform:translateY(-3px) scale(1.02); filter:brightness(1.06);}
.btn:active{transform:translateY(-1px) scale(.98);}
.btn--start{background-image:url('./images/btn-start.png');}
.btn--next{background-image:url('./images/btn-next.png');}
.btn--draw{background-image:url('./images/btn-draw.png');}
.btn--back{background-image:url('./images/btn-back.png');}
.btn--retry{background-image:url('./images/btn-retry.png');}

/* èƒ¡è˜¿è””åœ–ç‰‡ */
.carrot-thumb{
  width:clamp(var(--carrot-size-min),25vw,var(--carrot-size-max));
  height:clamp(var(--carrot-size-min),25vw,var(--carrot-size-max));
  object-fit:contain; transition:opacity .6s ease, transform .4s ease;
}
.carrot-thumb.fade-out{opacity:0; transform:scale(0.8);}

.fade-out{opacity:0!important; transform:scale(.95); transition:opacity .6s,transform .6s;}
.fade-in{opacity:1!important; transform:scale(1); transition:opacity .6s,transform .6s;}

footer{position:absolute; bottom:8px; font-size:.75rem; color:rgba(46,34,22,0.6);}
</style>
</head>
<body>

<div id="page1" class="page active">
  <h1>å‘½é‹ä¹‹è”” Â· æ£®æ—å åœç¥­å£‡</h1>
  <div class="subtitle">æ¢ç´¢å‘½é‹çš„å„€å¼ï¼Œå¾åŠ å…¥é–‹å§‹</div>
  <button id="startBtn" class="btn btn--start"></button>
  <footer>Â© 2025 å‘½é‹ä¹‹è””</footer>
</div>

<div id="page2" class="page">
  <h1>æƒæ QRCODE åŠ å…¥ Discord</h1>
  <div class="qr"><img src="https://api.qrserver.com/v1/create-qr-code/?size=130x130&data=https://discord.gg/mar4qT9XYn"></div>
  <button id="joinedBtn" class="btn btn--next"></button>
</div>

<div id="page3" class="page">
  <div class="divination">
    <img id="carrotThumb" class="carrot-thumb" src="./images/carrot-thumb.png">

    <div class="fortune-block">
      <div class="fortune" id="fortuneLine">
        æŒ‰ä¸‹ <strong>å åœé‹å‹¢</strong> æŒ–å–ä½ çš„å‘½é‹ä¹‹è””
      </div>
      <div class="fortune-text-container" id="fortuneResult"></div>
      <div class="advice" id="adviceText" style="display:none"></div>
    </div>

    <div class="button-row">
      <button id="drawBtn" class="btn btn--draw"></button>
      <button id="backBtn" class="btn btn--back"></button>
    </div>
  </div>
</div>

<script>
const apiUrl="https://carrot-bot-production.up.railway.app/api/web_fortune";
const userId="657882539331158016";
const username="æ¹¯å§†ç‘æ–—";
const drawBtn=document.getElementById('drawBtn');
const fortuneLine=document.getElementById('fortuneLine');
const adviceText=document.getElementById('adviceText');
const carrotThumb=document.getElementById('carrotThumb');
const page3=document.getElementById('page3');
const fortuneResult=document.getElementById('fortuneResult');

function transitionPage(cur,next){
  const curPage=document.getElementById(cur);
  const nextPage=document.getElementById(next);
  if(!curPage||!nextPage) return;
  curPage.classList.add('fade-out');
  setTimeout(()=>{
    curPage.classList.remove('active','fade-out');
    nextPage.classList.add('active','fade-in');
    setTimeout(()=>nextPage.classList.remove('fade-in'),600);
  },500);
}

document.getElementById('startBtn').onclick = ()=>transitionPage('page1','page2');
document.getElementById('joinedBtn').onclick = () => {
  transitionPage('page2','page3');
  // âœ… ä¿®æ­£ä½ç§»å•é¡Œ
  const carrotThumb = document.getElementById('carrotThumb');
  carrotThumb.style.transform = 'translate(0, 0)';
  carrotThumb.style.margin = '0 auto';
  carrotThumb.style.position = 'relative';
  carrotThumb.style.top = '0';
};
document.getElementById('backBtn').onclick = ()=>{
  page3.classList.remove('left-align');
  carrotThumb.style.display='block';
  carrotThumb.classList.remove('fade-out');
  fortuneLine.innerHTML='æŒ‰ä¸‹ <strong>å åœé‹å‹¢</strong> æŒ–å–ä½ çš„å‘½é‹ä¹‹è””';
  fortuneResult.innerHTML='';
  adviceText.style.display='none';
  drawBtn.classList.remove('btn--retry');
  drawBtn.classList.add('btn--draw');
  document.body.style.backgroundImage="url('./images/medieval-carrot-placeholder.webp')";
  transitionPage('page3','page1');
};

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

drawBtn.addEventListener('click', async ()=>{
  drawBtn.disabled = true;
  fortuneLine.innerHTML = "ğŸ¥• æŒ–å–ä¸­... æ­£åœ¨æ‹”å‡ºä½ çš„å‘½é‹ä¹‹è””...";
  adviceText.style.display = 'none';
  fortuneResult.innerHTML = '';

  // ğŸŒ€ è®“èƒ¡è˜¿è””å‹•ç•«å•Ÿå‹•ï¼ˆä¸Šä¸‹æŠ–å‹•ï¼‰
  carrotThumb.style.display = 'block';
  carrotThumb.classList.remove('fade-out');
  carrotThumb.animate(
    [
      { transform: 'translateY(0)' },
      { transform: 'translateY(-15px)' },
      { transform: 'translateY(0)' }
    ],
    { duration: 800, iterations: Infinity, easing: 'ease-in-out' }
  );
  const carrotAnimation = carrotThumb.getAnimations()[0];

  // ğŸ•“ é¡¯ç¤ºæ–‡å­—å‹•æ…‹ã€Œ...ã€
  let dots = 0;
  const loading = setInterval(() => {
    dots = (dots + 1) % 4;
    fortuneLine.innerHTML = "ğŸ¥• æŒ–å–ä¸­" + ".".repeat(dots) + " æ­£åœ¨æ‹”å‡ºä½ çš„å‘½é‹ä¹‹è””...";
  }, 500);

  try {
    // ğŸ”® å–å¾—å åœçµæœ
    const res = await fetch(`${apiUrl}?user_id=${userId}&username=${username}&force_random=true&t=${Date.now()}`, { cache: 'no-store' });
    const data = await res.json();
    const fortune = data.fortune || "";
    let fText = "", bg = "./images/fortune_default.png", className = "";

    if (fortune.includes("å¤§å‰")) { fText = "å¤§å‰"; bg = "./images/å¤§å‰.webp"; className = "å¤§å‰"; }
    else if (fortune.includes("ä¸­å‰")) { fText = "ä¸­å‰"; bg = "./images/ä¸­å‰.webp"; className = "ä¸­å‰"; }
    else if (fortune.includes("å°å‰")) { fText = "å°å‰"; bg = "./images/å°å‰.webp"; className = "å°å‰"; }
    else if (fortune.includes("å‰")) { fText = "å‰"; bg = "./images/å‰.webp"; className = "å‰"; }
    else if (fortune.includes("å‡¶")) { fText = "å‡¶"; bg = "./images/å‡¶.webp"; className = "å‡¶"; }

    // âœ… å»¶é²é¡¯ç¤ºçµæœï¼ˆä¾‹å¦‚ 4000ms = 4 ç§’ï¼‰
    setTimeout(() => {
      clearInterval(loading);
      carrotAnimation.cancel(); // åœæ­¢èƒ¡è˜¿è””æ™ƒå‹•

      // ğŸ¨ åˆ‡æ›èƒŒæ™¯èˆ‡ç•«é¢
      document.body.style.background = `url('${bg}') no-repeat center center/cover`;
      page3.classList.add('left-align');
      carrotThumb.classList.add('fade-out');
      setTimeout(() => carrotThumb.style.display = 'none', 600);

      fortuneLine.innerHTML = '';
      fortuneResult.innerHTML = fText;
      fortuneResult.className = `fortune-text-container ${className}`;
      adviceText.style.display = 'block';
      adviceText.innerHTML = `<p><span>${escapeHtml(data.advice)}</span></p>`;

      drawBtn.disabled = false;
    }, 4000); // â± é€™è£¡æ”¹ç­‰å¾…ç§’æ•¸ï¼ˆ4000 = 4ç§’ï¼‰

  } catch (e) {
    clearInterval(loading);
    carrotThumb.getAnimations().forEach(anim => anim.cancel());
    fortuneLine.innerHTML = 'âš ï¸ å åœå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦';
    adviceText.style.display = 'block';
    adviceText.innerHTML = '<p>é­”åŠ›å¹²æ“¾éå¼·ï¼Œç„¡æ³•å¾ç¥­å£‡è®€å–å‘½é‹ã€‚</p>';
    drawBtn.disabled = false;
  }
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    const registrations = await navigator.serviceWorker.getRegistrations();
    for (const reg of registrations) {
      await reg.unregister(); // å…ˆè§£é™¤æ‰€æœ‰èˆŠ SW
    }
    navigator.serviceWorker.register('/join-dc-Divination/sw.js?v=13', { updateViaCache: 'none' })
      .then(r => console.log('âœ… SW è¨»å†ŠæˆåŠŸ:', r.scope))
      .catch(e => console.log('âŒ SW è¨»å†Šå¤±æ•—:', e));
  });
}
</script>
</body>
</html>
