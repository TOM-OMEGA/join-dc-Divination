<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>命運之蔔 · 森林占卜祭壇</title>

<link rel="icon" href="images/favicon.ico" type="image/x-icon">
<meta name="theme-color" content="#000000">

<style>
:root{
  /* 🪄 全局調整區 */
  --paper:#f3ead5;
  --ink:#2e2316;
  --gold:#b9872b;

  /* 第三頁文字與間距 */
  --fortune-offset:5vh;       /* 大吉文字垂直位移 */
  --fortune-left-offset:110px;  /* 大吉文字距左邊偏移 */
  --advice-left-offset: 50px;    /* 小建議文字距左邊偏移（可分開調整） */
  --fortune-gap:150px;         /* 大吉文字與建議文字間距 */
  --draw-btn-gap:10px;         /* fortune/advice 到按鈕距離 */

  /* 胡蘿蔔圖片大小 */
  --carrot-size-min:150px;
  --carrot-size-max:220px;

  /* 按鈕大小 */
  --btn-width:200px;
  --btn-height:64px;
}

/* 字體設定 */
@font-face {
  font-family: 'MyChineseFont';
  src: url('/join-dc-Divination/fonts/MyChineseFont.woff') format('woff');
  font-display: swap;
}

@font-face {
  font-family: 'HanyiSentyPagoda';
  src: url('/join-dc-Divination/fonts/HanyiSentyPagoda-fixed.woff') format('woff'),
       url('/join-dc-Divination/fonts/HanyiSentyPagoda-fixed.ttf') format('truetype');
  font-display: swap;
}

/* 全域樣式 */
html, body{
  width:100%; height:100%; margin:0; padding:0;
  font-family:'MyChineseFont','Uncial Antiqua',serif;
  background:url('./images/medieval-carrot-placeholder.webp') no-repeat center center;
  background-size:contain; background-color:#000;
  color:var(--ink);
  overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  transition:background-image 1s ease-in-out;
}

/* 頁面共通 */
.page{
  position:absolute; top:0; left:0; width:100%; height:100%;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transform:scale(0.97);
  transition:opacity .8s ease, transform .8s ease;
}
.page.active{opacity:1; pointer-events:all; transform:scale(1);}

/* 第1頁 */
#page1 h1{font-size:clamp(3rem,12vw,3.8rem); color:#4d2b0a; margin-bottom:1rem; text-align:center;}
#page1 .subtitle{font-size:35pt; color:#333; text-align:center;}

/* 第2頁 */
#page2 h1{font-size:clamp(2.8rem,10vw,3.6rem); color:#4d2b0a; text-align:center; margin-bottom:1rem;}
.qr{width:130px; height:130px; border-radius:8px; overflow:hidden; margin-bottom:10px; box-shadow:0 3px 8px rgba(0,0,0,0.4);}
.qr img{width:100%; height:100%; object-fit:cover;}

/* 第3頁 */
#page3{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  text-align:center; width:100%; height:100%; box-sizing:border-box;
  transition:all 0.6s ease;
}
#page3.left-align{
  align-items:flex-start; text-align:left; padding-left:40px; transition:padding-left 0.4s ease;
}
@media screen and (max-width:1024px) and (orientation:landscape){#page3.left-align{padding-left:80px !important;}}
@media screen and (max-width:768px) and (orientation:portrait){#page3.left-align{align-items:center!important;text-align:center!important;padding-left:0!important;}}

/* 第3頁內容 */
.fortune-container{position:relative; min-height:120px;}
.fortune-text-container{
  position:absolute;
  top: var(--fortune-offset);
  left: var(--fortune-left-offset);
  transform: translateX(0);
  font-family:'HanyiSentyPagoda', serif;
  font-size: clamp(8rem,12vw,12rem);
  pointer-events:none; 
  white-space:nowrap;
}
.fortune-text-container.大吉,
.fortune-text-container.中吉,
.fortune-text-container.小吉,
.fortune-text-container.吉,
.fortune-text-container.凶{color:#4d2b0a;}

.fortune{font-size:clamp(1.2rem,4vw,1.8rem); z-index:1;}

/* 新容器: fortune-block 管理文字與間距 */
.fortune-block{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: var(--draw-btn-gap); /* fortune/advice 到按鈕距離 */
  margin-bottom:0;
}

.advice {
  position: relative;                  /* 允許左偏移 */
  margin-top: var(--fortune-gap);      /* 與運勢文字的距離 */
  left: var(--advice-left-offset);     /* 控制建議文字左右位移 */
  font-size: clamp(1.2rem, 2rem, 1.8rem);
  line-height: 1.6;
  max-width: 600px;
  color: #4b2d0a;
  font-family: 'MyChineseFont';
  text-align: left;                    /* 讓文字靠左對齊 */
  transition: margin-top .3s ease, left .3s ease;
}

/* 按鈕 */
.button-row{
  display:flex; flex-direction:row; align-items:center; justify-content:center;
  gap:10px;
  min-height:64px;
}

.btn{
  width:var(--btn-width); height:var(--btn-height);
  display:inline-block; background-repeat:no-repeat; background-position:center; background-size:contain;
  background-color:transparent; border:0; padding:0; margin:10px 6px; cursor:pointer; z-index:10;
}
.btn:hover{transform:translateY(-3px) scale(1.02); filter:brightness(1.06);}
.btn:active{transform:translateY(-1px) scale(.98);}
.btn--start{background-image:url('./images/btn-start.png');}
.btn--next{background-image:url('./images/btn-next.png');}
.btn--draw{background-image:url('./images/btn-draw.png');}
.btn--back{background-image:url('./images/btn-back.png');}
.btn--retry{background-image:url('./images/btn-retry.png');}

/* 胡蘿蔔圖片 */
.carrot-thumb{
  width:clamp(var(--carrot-size-min),25vw,var(--carrot-size-max));
  height:clamp(var(--carrot-size-min),25vw,var(--carrot-size-max));
  object-fit:contain; transition:opacity .6s ease, transform .4s ease;
}
.carrot-thumb.fade-out{opacity:0; transform:scale(0.8);}

.fade-out{opacity:0!important; transform:scale(.95); transition:opacity .6s,transform .6s;}
.fade-in{opacity:1!important; transform:scale(1); transition:opacity .6s,transform .6s;}

footer{position:absolute; bottom:8px; font-size:.75rem; color:rgba(46,34,22,0.6);}
</style>
</head>
<body>

<div id="page1" class="page active">
  <h1>命運之蔔 · 森林占卜祭壇</h1>
  <div class="subtitle">探索命運的儀式，從加入開始</div>
  <button id="startBtn" class="btn btn--start"></button>
  <footer>© 2025 命運之蔔</footer>
</div>

<div id="page2" class="page">
  <h1>掃描 QRCODE 加入 Discord</h1>
  <div class="qr"><img src="https://api.qrserver.com/v1/create-qr-code/?size=130x130&data=https://discord.gg/mar4qT9XYn"></div>
  <button id="joinedBtn" class="btn btn--next"></button>
</div>

<div id="page3" class="page">
  <div class="divination">
    <img id="carrotThumb" class="carrot-thumb" src="./images/carrot-thumb.png">

    <div class="fortune-block">
      <div class="fortune" id="fortuneLine">
        按下 <strong>占卜運勢</strong> 挖取你的命運之蔔
      </div>
      <div class="fortune-text-container" id="fortuneResult"></div>
      <div class="advice" id="adviceText" style="display:none"></div>
    </div>

    <div class="button-row">
      <button id="drawBtn" class="btn btn--draw"></button>
      <button id="backBtn" class="btn btn--back"></button>
    </div>
  </div>
</div>

<script>
const apiUrl="https://carrot-bot-production.up.railway.app/api/web_fortune";
const userId="657882539331158016";
const username="湯姆瑞斗";
const drawBtn=document.getElementById('drawBtn');
const fortuneLine=document.getElementById('fortuneLine');
const adviceText=document.getElementById('adviceText');
const carrotThumb=document.getElementById('carrotThumb');
const page3=document.getElementById('page3');
const fortuneResult=document.getElementById('fortuneResult');

function transitionPage(cur,next){
  const curPage=document.getElementById(cur);
  const nextPage=document.getElementById(next);
  if(!curPage||!nextPage) return;
  curPage.classList.add('fade-out');
  setTimeout(()=>{
    curPage.classList.remove('active','fade-out');
    nextPage.classList.add('active','fade-in');
    setTimeout(()=>nextPage.classList.remove('fade-in'),600);
  },500);
}

document.getElementById('startBtn').onclick = ()=>transitionPage('page1','page2');
document.getElementById('joinedBtn').onclick = () => {
  transitionPage('page2','page3');
  // ✅ 修正位移問題
  const carrotThumb = document.getElementById('carrotThumb');
  carrotThumb.style.transform = 'translate(0, 0)';
  carrotThumb.style.margin = '0 auto';
  carrotThumb.style.position = 'relative';
  carrotThumb.style.top = '0';
};
document.getElementById('backBtn').onclick = ()=>{
  page3.classList.remove('left-align');
  carrotThumb.style.display='block';
  carrotThumb.classList.remove('fade-out');
  fortuneLine.innerHTML='按下 <strong>占卜運勢</strong> 挖取你的命運之蔔';
  fortuneResult.innerHTML='';
  adviceText.style.display='none';
  drawBtn.classList.remove('btn--retry');
  drawBtn.classList.add('btn--draw');
  document.body.style.backgroundImage="url('./images/medieval-carrot-placeholder.webp')";
  transitionPage('page3','page1');
};

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

drawBtn.addEventListener('click', async ()=>{
  drawBtn.disabled = true;
  fortuneLine.innerHTML = "🥕 挖取中... 正在拔出你的命運之蔔...";
  adviceText.style.display = 'none';
  fortuneResult.innerHTML = '';

  // 🌀 讓胡蘿蔔動畫啟動（上下抖動）
  carrotThumb.style.display = 'block';
  carrotThumb.classList.remove('fade-out');
  carrotThumb.animate(
    [
      { transform: 'translateY(0)' },
      { transform: 'translateY(-15px)' },
      { transform: 'translateY(0)' }
    ],
    { duration: 800, iterations: Infinity, easing: 'ease-in-out' }
  );
  const carrotAnimation = carrotThumb.getAnimations()[0];

  // 🕓 顯示文字動態「...」
  let dots = 0;
  const loading = setInterval(() => {
    dots = (dots + 1) % 4;
    fortuneLine.innerHTML = "🥕 挖取中" + ".".repeat(dots) + " 正在拔出你的命運之蔔...";
  }, 500);

  try {
    // 🔮 取得占卜結果
    const res = await fetch(`${apiUrl}?user_id=${userId}&username=${username}&force_random=true&t=${Date.now()}`, { cache: 'no-store' });
    const data = await res.json();
    const fortune = data.fortune || "";
    let fText = "", bg = "./images/fortune_default.png", className = "";

    if (fortune.includes("大吉")) { fText = "大吉"; bg = "./images/大吉.webp"; className = "大吉"; }
    else if (fortune.includes("中吉")) { fText = "中吉"; bg = "./images/中吉.webp"; className = "中吉"; }
    else if (fortune.includes("小吉")) { fText = "小吉"; bg = "./images/小吉.webp"; className = "小吉"; }
    else if (fortune.includes("吉")) { fText = "吉"; bg = "./images/吉.webp"; className = "吉"; }
    else if (fortune.includes("凶")) { fText = "凶"; bg = "./images/凶.webp"; className = "凶"; }

    // ✅ 延遲顯示結果（例如 4000ms = 4 秒）
    setTimeout(() => {
      clearInterval(loading);
      carrotAnimation.cancel(); // 停止胡蘿蔔晃動

      // 🎨 切換背景與畫面
      document.body.style.background = `url('${bg}') no-repeat center center/cover`;
      page3.classList.add('left-align');
      carrotThumb.classList.add('fade-out');
      setTimeout(() => carrotThumb.style.display = 'none', 600);

      fortuneLine.innerHTML = '';
      fortuneResult.innerHTML = fText;
      fortuneResult.className = `fortune-text-container ${className}`;
      adviceText.style.display = 'block';
      adviceText.innerHTML = `<p><span>${escapeHtml(data.advice)}</span></p>`;

      drawBtn.disabled = false;
    }, 4000); // ⏱ 這裡改等待秒數（4000 = 4秒）

  } catch (e) {
    clearInterval(loading);
    carrotThumb.getAnimations().forEach(anim => anim.cancel());
    fortuneLine.innerHTML = '⚠️ 占卜失敗，請稍後重試';
    adviceText.style.display = 'block';
    adviceText.innerHTML = '<p>魔力干擾過強，無法從祭壇讀取命運。</p>';
    drawBtn.disabled = false;
  }
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    const registrations = await navigator.serviceWorker.getRegistrations();
    for (const reg of registrations) {
      await reg.unregister(); // 先解除所有舊 SW
    }
    navigator.serviceWorker.register('/join-dc-Divination/sw.js?v=13', { updateViaCache: 'none' })
      .then(r => console.log('✅ SW 註冊成功:', r.scope))
      .catch(e => console.log('❌ SW 註冊失敗:', e));
  });
}
</script>
</body>
</html>
