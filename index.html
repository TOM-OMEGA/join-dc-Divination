<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>命運之蔔 · 中世紀占卜祭壇</title>

  <!-- 古風字體 -->
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">

  <style>
    :root {
      --paper: #f3ead5;
      --ink: #2e2316;
      --gold: #b9872b;
      --max-width: 980px;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: "Uncial Antiqua", serif;
      background: url('images/scroll-bg.jpg') repeat center center fixed;
      background-size: cover;
      color: var(--ink);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stage {
      box-sizing: border-box;
      width: var(--max-width);
      max-width: 95%;
      <body>
  <div class="stage" role="main" aria-labelledby="title" id="mainStage">
    <header>
      <div class="title">
        <div class="crest" aria-hidden="true">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2c2.8 0 5 2.2 5 5 0 1.9-.9 3.6-2.3 4.7L12 18 9.3 11.7C7.9 10.6 7 8.9 7 7c0-2.8 2.2-5 5-5z"/>
          </svg>
        </div>
        <div>
          <h1 id="title">命運之蔔 · 森林占卜祭壇</h1>
          <div class="subtitle">加入 Discord 並領取你的專屬胡蘿蔔占卜</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-size:0.86rem;color:rgba(46,34,22,0.6)">中世紀手抄本風 · 莊嚴神秘</div>
      </div>
    </header>

    <section class="content">
      <!-- 首頁 QR 區塊 -->
      <div class="panel" id="home-panel">
        <div class="qr-wrap">
          <div class="qr" title="掃描加入 Discord">
            <img id="qr-img" alt="Discord QR" src="https://api.qrserver.com/v1/create-qr-code/?size=600x600&data=https://discord.gg/mar4qT9XYn" />
          </div>
          <div class="muted">掃描或點擊 QR 加入 Discord 群組</div>
          <a href="https://discord.gg/mar4qT9XYn" target="_blank" rel="noopener" class="btn secondary">打開 Discord 邀請連結</a>
        </div>
        <div style="margin-top:14px;">
          <div style="font-weight:700;margin-bottom:8px">步驟</div>
          <ol style="margin:0 0 8px 18px;color:rgba(46,34,22,0.8)">
            <li>掃描上方 QR 或點擊邀請加入 Discord</li>
            <li>完成後回到此頁按「我已加入」繼續占卜</li>
          </ol>
          <button id="joinedBtn" class="btn" title="我已加入">我已加入</button>
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(0,0,0,0.06)">
        <div style="font-size:0.92rem;color:rgba(46,34,22,0.72)">
          <strong>注意：</strong>可替換背景圖（<code>images/scroll-bg.jpg</code>）與縮圖（<code>images/carrot-thumb.png</code>）。
        </div>
      </div>
      <!-- 占卜畫面 -->
      <div class="divination" id="divination-panel" aria-hidden="true">
        <div class="div-inner">
          <div class="magic-plate">
            <img id="carrotThumb" class="carrot-thumb" src="images/carrot-thumb.png" alt="胡蘿蔔插畫" onerror="this.style.display='none'">
            <div class="fortune" id="fortuneLine">按下 <strong>占卜今日運勢</strong> 來喚醒命運之蔔</div>
            <div class="advice" id="adviceText"></div>
            <div class="small-row">
              <button id="drawBtn" class="btn">占卜今日運勢 ✨</button>
              <button id="backBtn" class="btn secondary">返回首頁</button>
            </div>
          </div>
          <div style="margin-top:8px;color:rgba(46,34,22,0.6);font-size:0.88rem">占卜使用：你的 bot API（已連線）</div>
        </div>
      </div>
    </section>

    <footer>© 命運之蔔 · 祭壇系統</footer>
  </div>
      <script>
const apiUrl = "https://carrot-bot-production.up.railway.app/api/fortune";
const userId = "657882539331158016";
const username = "湯姆瑞斗";

const joinedBtn = document.getElementById('joinedBtn');
const divinationPanel = document.getElementById('divination-panel');
const homePanel = document.getElementById('home-panel');
const drawBtn = document.getElementById('drawBtn');
const fortuneLine = document.getElementById('fortuneLine');
const adviceText = document.getElementById('adviceText');
const backBtn = document.getElementById('backBtn');

// 切換到占卜畫面
joinedBtn.addEventListener('click', () => {
  homePanel.style.display = 'none';
  divinationPanel.classList.add('show');
});

// 返回首頁
backBtn.addEventListener('click', () => {
  divinationPanel.classList.remove('show');
  homePanel.style.display = '';
});

// 占卜按鈕
drawBtn.addEventListener('click', async () => {
  drawBtn.disabled = true;
  drawBtn.textContent = '占卜中... 🔮';
  fortuneLine.innerHTML = '占卜中... 請稍候';
  adviceText.innerHTML = '';

  try {
    const res = await fetch(`${apiUrl}?user_id=${encodeURIComponent(userId)}&username=${encodeURIComponent(username)}`);
    if (!res.ok) throw new Error('API 回傳錯誤');
    const data = await res.json();

    fortuneLine.innerHTML = `📜 占卜日期：<strong>${escapeHtml(data.date || new Date().toLocaleDateString())}</strong>`;
    adviceText.innerHTML = `
      <p style="margin:6px 0;"><strong style="color:var(--gold)">${escapeHtml(data.fortune || '靜默')}</strong></p>
      <p style="margin-top:6px">${escapeHtml(data.advice || '無建議')}</p>
    `;
    drawBtn.textContent = '再次占卜';
  } catch (e) {
    fortuneLine.innerHTML = '⚠️ 占卜失敗，請稍後重試';
    adviceText.innerHTML = '<p>魔力干擾過強，無法從祭壇讀取命運。</p>';
    drawBtn.textContent = '再試一次';
  } finally {
    drawBtn.disabled = false;
  }
});

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, c => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
  }[c]));
}
</script>
</body>
</html>
